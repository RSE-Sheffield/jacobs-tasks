<!DOCTYPE html>
<html>

  <head>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-canvas-button-response.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="config/expt1_config.js"></script>
    <script src="functions/expt1_func.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
  </head>

  <body>
    <canvas id="canvas" width="500" height="500">
    </canvas>

    <script>

        const canvas = document.getElementById("canvas");
        const jsPsych = initJsPsych({
            on_finish: function() {
                const d = new Date();
                var filename = d.toISOString() + "_testdata.csv"
                jsPsych.data.get().localSave('csv', filename);
            }
        });

        var canvasCentre = [canvas.width/2 - config.stimSize/2, canvas.height/2 - config.stimSize/2]
        var [correctCount, incorrectCount] = [0, 0];
        
        var nStimuli = config.startValue
        
        var timeline = [];

        // Standard fixation object
        var fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div style="font-size:60px;">+</div>',
            choices: "NO_KEYS",
            trial_duration: config.fixationDuration,
            data: {
                screen: 'fixation'
            }
        };

        // Generate target array
        var target_array = {
            type: jsPsychCanvasButtonResponse,
            // Befre each run shuffle the available colours and split into used
            // and unused
            on_start: function(trial){
                shuffColours = jsPsych.randomization.shuffle(config.colours)
                usedCols = shuffColours.slice(0, nStimuli)
                unusedCols = shuffColours.slice(nStimuli, )
            },
            // Draw the used colours on screen
            stimulus: function(c) {
                drawRects(c, usedCols);
            },
            canvas_size: [canvas.width, canvas.height],
            trial_duration: config.stimulusDuration,
            post_trial_gap: config.blankDuration,
            data: {
                screen: "memory array"
            },
            choices: []
        }

        // generate response display
        var response_display = {
            type: jsPsychCanvasButtonResponse,
            // before the trial decide whether the probe will come from the
            // used or unused colours (based on TL variable)
            on_start: function(trial) {
                if (jsPsych.timelineVariable('probe_present')) {
                    probe_col = usedCols[0];
                } else {
                    probe_col = unusedCols[0];
                }
            },
            // Draw the probe rectangle
            stimulus: function(c) {
                drawRect(c, ...canvasCentre, config.stimSize, probe_col);
            },
            data: {
                screen: "probe",
                probe_present: jsPsych.timelineVariable('probe_present'),
                correct_response: jsPsych.timelineVariable('correct_response'),
            },
            // Add more info to the data object, but these things are only
            // available after the trial has finished
            on_finish: function(data) {
                data.probe_colour = probe_col
                data.correct = data.response == data.correct_response
                data.nTargets = nStimuli

                // Update nStimuli based on staircase rules set in config file
                if (data.correct) {
                    correctCount += 1;
                    if (correctCount == config.staircaseUp) {
                        [correctCount, incorrectCount] = [0, 0];
                        if (nStimuli < config.maxValue) nStimuli += 1;
                    }
                } else {
                    incorrectCount += 1;
                    if (incorrectCount == config.staircaseDown) {
                        [correctCount, incorrectCount] = [0, 0];
                        if (nStimuli > config.minValue) nStimuli -= 1;
                    }
                }
            },
            canvas_size: [canvas.width, canvas.height],
            choices: ["yes", "no"]
        }

        var expt1_procedure = {
            timeline: [
                fixation,
                target_array,
                response_display
            ],
            timeline_variables: [
                {probe_present: true, correct_response: 0},
                {probe_present: false, correct_response: 1}
            ],
            sample: {
                type: 'fixed-repetitions',
                size: config.nTrialReps
            },
        }; 

        timeline.push(expt1_procedure)

        jsPsych.run(timeline)


    </script>

  </body>

</html>
